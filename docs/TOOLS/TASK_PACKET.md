# Task Packet Specification

A Task Packet is the atomic unit of work in the orchestration system.
**One task = one directory.** All inputs and outputs are files within that directory.

Global defaults are loaded from split config files:

- `configs/servant/*.yaml`
- `configs/pipeline/*.yaml`
  Task Packet `manifest.yaml` may override a subset of routing keys.

## Directory Structure

```
.tmp/task/<task-id>/
  manifest.yaml            # Sole entry point — defines all task parameters
  inputs/
    user_request.md        # What the user wants (dynamic)
    context_pack.md        # Shared project context (dynamic, updated each brief)
    context_pack.digest.md # Compressed context (auto-generated by make_digest.sh)
    attachments/
      git.diff             # Optional: current git diff
      logs.txt             # Optional: trimmed build/test logs
      notes.md             # Optional: additional context
    prompt/
      <tool>.<role>.md     # Composed prompt (auto-generated by compose_prompt.sh)
  outputs/
    <stage>.<tool>.out     # Raw model output
    <stage>.<tool>.err     # Stderr from wrapper
    <stage>.<tool>.meta.json  # Execution metadata
    <stage>.artifact.md    # Structured artifact (verify role)
    <stage>.<tool>.compose.log # Prompt composition execution log
    <stage>.<tool>.wrapper.log # Wrapper execution log
    _summary.md            # Claude-facing fixed-length summary (≤80 lines)
  state/
    stats.json             # Paid calls, completed stages, error signatures
    last_failure.json      # Triage result of the most recent failure
    acceptance.commands.override # Optional brief-derived verify command override
  done/
    <stage>.done           # Completion marker (written after gate passes)
```

## manifest.yaml Fields

| Field                           | Type   | Required | Description                                                                            |
| ------------------------------- | ------ | -------- | -------------------------------------------------------------------------------------- |
| `task_id`                       | string | Yes      | Unique identifier (e.g., `20260218-001`)                                               |
| `goal`                          | string | Yes      | One-sentence task description                                                          |
| `routing.intent`                | enum   | Yes      | `safe_impl\|one_shot_impl\|design_only\|review_only\|review_cross\|post_impl_review`   |
| `routing.model.codex`           | string | No       | Task-level Codex model override (must be allowed by split config)                      |
| `routing.model.gemini`          | string | No       | Task-level Gemini model override (must be allowed by split config)                     |
| `routing.model.copilot`         | string | No       | Task-level Copilot model override (must be allowed by split config)                    |
| `routing.pipeline.profile`      | string | No       | Profile override within the resolved pipeline group                                    |
| `routing.pipeline.flags.*`      | map    | No       | Boolean stage toggles (strictly validated)                                             |
| `routing.pipeline.options.*`    | map    | No       | Enum options (strictly validated, includes `impl_mode`, `review_mode`, `timeout_mode`) |
| `scope.allow[]`                 | list   | Yes      | Paths that may be modified                                                             |
| `scope.deny[]`                  | list   | Yes      | Paths that must not be modified                                                        |
| `acceptance.commands[]`         | list   | Yes      | Shell commands to verify completion                                                    |
| `acceptance.criteria[]`         | list   | Yes      | Human-readable acceptance criteria                                                     |
| `budgets.retry_budget`          | int    | Yes      | Max retries per error signature                                                        |
| `budgets.paid_call_budget`      | int    | Yes      | Max total paid API calls                                                               |
| `budgets.max_wallclock_sec`     | int    | Yes      | Max seconds per wrapper invocation                                                     |
| `context.digest_policy`         | enum   | Yes      | `off\|auto\|aggressive`                                                                |
| `security.redaction_patterns[]` | list   | No       | Regex patterns to redact from inputs                                                   |
| `security.forbidden_paths[]`    | list   | No       | Paths that must not appear in any input                                                |

## Stage Name Convention

Stage names follow the format `<tool>_<role>`:

| Tool      | Roles                                             |
| --------- | ------------------------------------------------- |
| `gemini`  | `brief`, `review`, `test_design`, `static_verify` |
| `codex`   | `impl`, `verify`, `review`, `test_impl`           |
| `copilot` | `runbook`, `review`, `review_consolidate`         |

Examples: `gemini_brief`, `codex_impl`, `copilot_runbook`

## meta.json Schema

```json
{
  "stage": "gemini_brief",
  "tool": "gemini",
  "exit_code": 0,
  "start": "2026-02-18T12:00:00Z",
  "end": "2026-02-18T12:01:30Z",
  "duration_sec": 90,
  "prompt_sha256": "abc123..."
}
```

## \_summary.md Contract

- Maximum 80 lines
- Always updated after each stage (success or failure)
- Contains: stage status, exit codes, error class/signature, next_action suggestion
- Error details: head 20 + tail 20 lines of stderr only
- Claude reads ONLY this file in Opaque Mode

## Brief-to-Implementation Handoff

- After `gemini_brief` passes gate, dispatcher extracts `## Updated Context Pack` and rewrites `inputs/context_pack.md`.
- Dispatcher also extracts the `## Verify Commands` code block into `state/acceptance.commands.override` when available.
- `codex_verify` uses the override commands first; if not present, it falls back to `acceptance.commands[]` from `manifest.yaml`.

## Console Output Policy

- Dispatcher keeps subprocess output out of the main terminal by default.
- During execution, it prints stage progress (`started` / `running` / `completed`) at fixed intervals.
- On failure, it prints only a short tail excerpt from the related log file.

## Review Cross Routing

- `routing.intent: review_cross` runs:
  1. `gemini_review`
  2. `codex_review`
  3. `copilot_review_consolidate`
- For `review_consolidate`, dispatcher automatically attaches previous review outputs from `outputs/` to the final consolidate prompt input.

## Post-Implementation Review Routing

- `routing.intent: post_impl_review` runs:
  1. `gemini_review` (R1 wide review)
  2. `gemini_test_design` (T1 test matrix)
  3. `gemini_static_verify` (V1 static verification checklist)
  4. `codex_review` (R2 precision review)
  5. `codex_test_impl` (T2 test implementation proposal)
  6. `codex_verify` (V2 dynamic verification)
- Helper script:
  - `./scripts/agent-cli/post_impl_review.sh <context-pack-path> <impl-report-path> [output-dir]`

## Retention Policy

- Keep task directory for current session
- After completion: archive to `.tmp/archive/<task-id>/` or delete
- `outputs/_summary.md` and `done/` markers may be preserved for audit
